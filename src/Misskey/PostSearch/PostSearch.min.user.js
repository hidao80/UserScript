// ==UserScript==
// @name         Misskey v11 Post Log Search
// @name:ja      Misskey v11 投稿ログ検索
// @namespace    https://github.com/hidao80
// @version      1.0.4
// @description  Search through Misskey v11 posts via API
// @description:ja Misskey v11の投稿をAPI経由で検索
// @icon         https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/72x72/1f50d.png
// @author       hidao80
// @match        https://misskey.dev/*
// @grant        GM_xmlhttpRequest
// @run-at       document-end
// @updateURL    https://github.com/hidao80/UserScript/raw/main/src/Misskey/PostSearch/PostSearch.user.js
// @downloadURL  https://github.com/hidao80/UserScript/raw/main/src/Misskey/PostSearch/PostSearch.min.user.js
// ==/UserScript==
"use strict";(n=>{const e=false;const t="MissQueryUS";const o={};["log","debug","warn","info","error"].forEach((n=>{o[n]=e?window.console[n]:function(){}}));const i=n=>document.createElement(n);const s=n=>document.querySelector(n);const r=n=>document.querySelectorAll(n);const l=Array.from(t).reduce(((n,e)=>(n<<5)-n+e.charCodeAt(0)),0).toString(16);const a=n=>{const e=document.querySelectorAll(n);return 1==e.length?e[0]:e};o.debug(`[${t}]: Script Loading... [HASH = ${l}]`);function d(){const n=s(`#${t}-search`);if(n){o.debug(`[${t}]: Search interface already exists`);return}const e=localStorage.getItem("vuex");const r=e?JSON.parse(e).i:null;if(!r){o.debug(`[${t}]: No API token found`);return}const l=new URL(location.href);const a=`${l.protocol}//${l.hostname}`;try{const d=i("div");d.id=`${t}-search`;d.style.cssText=`\n                position: fixed;\n                top: 10px;\n                right: 10px;\n                background: white;\n                padding: 10px;\n                border-radius: 8px;\n                box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n                z-index: 5020;\n                font-family: sans-serif;\n                max-width: calc(100% - 20px);\n                box-sizing: border-box;\n                opacity: 0.9;\n                transition: all 0.3s ease;\n                display: none;\n            `;const c=500;let p=null;let u=false;let x,g;const h=10;const b=i("input");b.type="text";b.placeholder="投稿を検索...";b.style.cssText=`\n                width: 100%;\n                padding: 8px;\n                margin-bottom: 10px;\n                border: 1px solid #ccc;\n                border-radius: 4px;\n                box-sizing: border-box;\n                font-size: 14px;\n                transition: all 0.3s ease;\n            `;const y=i("div");y.style.cssText=`\n                width: 100%;\n                margin-bottom: 10px;\n                display: flex;\n                gap: 8px;\n            `;const f=i("input");f.type="text";f.placeholder="JSON ファイルの URL（任意）...";f.style.cssText=`\n                flex-grow: 1;\n                height: 36px;\n                padding: 8px;\n                border: 1px solid #ccc;\n                border-radius: 4px;\n                box-sizing: border-box;\n                font-size: 14px;\n                background: white;\n                margin: 0;\n            `;const m=i("button");m.textContent="非表示";m.style.cssText=`\n                padding: 0 12px;\n                height: 36px;\n                border: 1px solid #ccc;\n                border-radius: 4px;\n                background: white;\n                cursor: pointer;\n                font-size: 14px;\n                white-space: nowrap;\n                transition: all 0.2s ease;\n            `;m.addEventListener("mouseenter",(()=>{m.style.backgroundColor="#f0f0f0"}));m.addEventListener("mouseleave",(()=>{m.style.backgroundColor="white"}));m.addEventListener("click",(n=>{n.stopPropagation();const e=!f.disabled;f.disabled=e;if(e){f.value="";m.textContent="表示";f.style.backgroundColor="#f5f5f5";f.style.color="#999"}else{m.textContent="非表示";f.style.backgroundColor="white";f.style.color="black";const n=localStorage.getItem(`${t}-jsonUrl`);if(n){f.value=n}}}));const v=localStorage.getItem(`${t}-jsonUrl`);if(v){f.value=v}f.addEventListener("change",(()=>{const n=f.value.trim();if(n&&!f.disabled){localStorage.setItem(`${t}-jsonUrl`,n);o.debug(`[${t}]: Saved JSON URL to localStorage`)}else{localStorage.removeItem(`${t}-jsonUrl`);o.debug(`[${t}]: Removed JSON URL from localStorage`)}}));const w=i("button");w.type="button";w.innerHTML=`\n                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">\n                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>\n                </svg>`;w.style.cssText=`\n                cursor: pointer;\n                flex-shrink: 0;\n                color: #666;\n                padding: 6px;\n                border-radius: 4px;\n                transition: all 0.2s ease;\n                height: 36px;\n                width: 36px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                box-sizing: border-box;\n                border: 1px solid #ccc;\n                background: white;\n            `;w.addEventListener("mouseenter",(()=>{w.style.backgroundColor="#f0f0f0"}));w.addEventListener("mouseleave",(()=>{w.style.backgroundColor="white"}));const S=i("div");S.id=`${t}-help-modal`;S.style.cssText=`\n                display: none;\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100dvw;\n                height: 100dvh;\n                background: rgba(0, 0, 0, 0.7);\n                z-index: 5050;\n                opacity: 0;\n                transition: opacity 0.3s ease;\n            `;const k=i("div");k.style.cssText=`\n                position: relative;\n                width: 90%;\n                max-width: 90%;\n                margin: 40px auto;\n                max-height: 90%;\n                height: auto;\n                background: white;\n                padding: 20px;\n                border-radius: 8px;\n                box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n                transform: translateY(-20px);\n                transition: transform 0.3s ease;\n                overflow-y: scroll;\n            `;k.innerHTML=`\n                <h2 style="margin-top: 0; margin-bottom: 20px; color: #333;">投稿検索の使い方</h2>\n                <div style="color: #666; line-height: 1.6;">\n                    <h3 style="color: #333; margin: 16px 0 8px;">検索インターフェースの表示</h3>\n                    <p>ページ上の任意の場所をロングタップ（マウスの場合は長押し）すると、検索インターフェースの表示/非表示を切り替えられます。</p>\n\n                    <h3 style="color: #333; margin: 16px 0 8px;">JSONファイルの設定</h3>\n                    <ol>\n                        <li>投稿をJSONファイルとしてエクスポートし、アクセス可能な場所にホストします。Misskey内の自分のストレージ内でも構いません。</li>\n                        <li>入力フィールドにJSONファイルのURLを入力します</li>\n                        <li>URLは自動的に保存され、次回以降も使用できます</li>\n                    </ol>\n                    <h3 style="color: #333; margin: 16px 0 8px;">JSONフォーマット</h3>\n                    <p>JSONファイルは以下の構造を持つ投稿オブジェクトの配列である必要があります：</p>\n                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;">[\n    {\n        "text": "投稿内容",\n        "createdAt": "2023-01-01T00:00:00.000Z"\n    },\n    ...\n]</pre>\n\n                    <h3 style="color: #333; margin: 16px 0 8px;">投稿の検索</h3>\n                    <ol>\n                    <li>検索ボックスに検索キーワードを入力します</li>\n                    <li>入力に応じて結果が自動的に更新されます</li>\n                    <li>結果は日付の降順で表示されます</li>\n                    </ol>\n                    <h3 style="color: #333; margin: 16px 0 8px;">URL入力オプション</h3>\n                    <p>非表示/表示ボタンを使用して、URL入力を一時的に無効にできます</p>\n                </div>\n                <button style="\n                    position: absolute;\n                    top: 10px;\n                    right: 10px;\n                    background: none;\n                    border: none;\n                    font-size: 24px;\n                    cursor: pointer;\n                    color: #666;\n                    padding: 5px;\n                    line-height: 1;\n                ">×</button>\n            `;const L=k.querySelector("button");L.addEventListener("click",(n=>{n.stopPropagation();S.style.opacity="0";k.style.transform="translateY(-20px)";setTimeout((()=>{S.style.display="none"}),300)}));const C=n=>{n.preventDefault();n.stopPropagation();S.style.display="block";requestAnimationFrame((()=>{S.style.opacity="1";k.style.transform="translateY(0)"}))};w.onclick=C;S.addEventListener("click",(n=>{if(n.target===S){L.click()}}));S.appendChild(k);d.style.width="300px";y.appendChild(f);y.appendChild(m);y.appendChild(w);const $=i("div");$.style.cssText=`\n                max-height: 400px;\n                overflow-y: auto;\n                font-size: 14px;\n                width: 100%;\n                box-sizing: border-box;\n                transition: all 0.3s ease;\n            `;d.appendChild(y);d.appendChild(b);d.appendChild($);document.body.appendChild(d);document.body.appendChild(S);document.addEventListener("mousedown",T);document.addEventListener("mouseup",z);document.addEventListener("touchstart",E,{passive:true});document.addEventListener("touchend",z,{passive:true});document.addEventListener("touchcancel",z,{passive:true});function T(n){if(n.button!==0)return;if(d.contains(n.target))return;u=true;x=n.clientX;g=n.clientY;p=setTimeout((()=>{if(u){const n=d.style.display==="none";d.style.display=n?"block":"none";o.debug(`[${t}]: Display toggled to ${n?"show":"hide"}`);if(n){b.focus()}}}),c)}function z(){clearTimeout(p);u=false}function E(n){if(d.contains(n.target))return;u=true;const e=n.touches[0];x=e.clientX;g=e.clientY;p=setTimeout((()=>{if(u){const n=d.style.display==="none";d.style.display=n?"block":"none";o.debug(`[${t}]: Display toggled to ${n?"show":"hide"}`);if(n){b.focus()}}}),c)}o.debug(`[${t}]: Search interface initialized`)}catch(U){o.error(`[${t}]: Script error:`,U)}}document.addEventListener("DOMContentLoaded",setTimeout((()=>{d()}),3e3))})();
